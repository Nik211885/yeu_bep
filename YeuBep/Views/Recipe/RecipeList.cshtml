@using Microsoft.EntityFrameworkCore
@using YeuBep.Data
@using YeuBep.Entities
@using YeuBep.Helpers
@model PaginationViewModel<YeuBep.ViewModels.Recipe.RecipeViewModel>
@inject YeuBepDbContext DbContext
@{
    var topCategories = await DbContext.Categories
        .Where(x=>x.IsActive)
        .OrderByDescending(x=>x.CountRecipe)
        .ThenByDescending(x=>x.CreatedDate)
        .Take(5)
        .AsNoTracking()
        .ToListAsync();
    var topRecipeView = await DbContext.Recipes
        .Where(x => x.RecipeStatus == RecipeStatus.Accept)
        .OrderByDescending(x => x.Views)
        .ThenByDescending(x=>x.CreatedDate)
        .Take(3)
        .ToListAsync();
    var search = Context.Request.Query["search"].ToString();
}
<link rel="stylesheet" href="~/css/index.css" />

<form method="get" asp-action="Recipe" asp-controller="Recipe" class="search-form">
    <div class="search-container">
        <div class="search-icon-wrapper">
            <i class="bi bi-search"></i>
        </div>
        <input type="text"
               id="search"
               name="search" 
               class="search-field" 
               placeholder="Khám phá công thức món ăn yêu thích..." 
               autocomplete="off"
               value="@search">
        <button class="search-button" type="submit">
            <span>Tìm kiếm</span>
            <i class="bi bi-arrow-right ms-2"></i>
        </button>
    </div>
    <div class="autocomplete-dropdown" id="autocompleteDropdown"></div>
</form>

<div class="main-layout">
    <!-- Content Area -->
    <div class="content-area">
        <div class="row pb-5">
            @foreach (var item in Model.Items)
            {
                @await Component.InvokeAsync("RecipeCardSearchComponent", item)
            }
        </div>
        @await Component.InvokeAsync("PaginationComponent", Model.PaginationView)
    </div>

    <!-- Sidebar -->
    <aside class="sidebar">
        <!-- Danh mục món ăn -->
        <div class="sidebar-card">
            <h3><i class="bi bi-bookmark-fill me-2"></i>Danh Mục Phổ Biến</h3>
            <ul class="category-list">
                @foreach (var category in topCategories)
                {
                    <li class="category-item">
                        <a class="text-decoration-none" href="@Url.Action("Slug", "Category", new{slug = category.Slug})">
                            <span class="category-name">@category.Emoji @category.Title</span>
                            <span class="category-count">@category.CountRecipe</span>
                        </a>
                    </li>   
                }
            </ul>
        </div>

        <!-- Món ăn trending -->
        <div class="sidebar-card">
            <h3><i class="bi bi-fire me-2"></i>Đang Hot</h3>
            @foreach(var recipe in topRecipeView)
            {
                <a class="text-decoration-none" href="@Url.Action("Slug", "Recipe", new {slug = recipe.Slug})">
                    <div class="trending-recipe">
                        <img src="@recipe.Avatar" alt="" class="trending-img">
                        <div class="trending-info">
                            <h4>@recipe.Title</h4>
                            <div class="trending-meta">
                                <i class="bi bi-eye"></i> @StringHelper.ConvertToStringValue(recipe.Views) lượt xem
                            </div>
                        </div>
                    </div>   
                </a>
            }
        </div>
        <!-- Tips nấu ăn -->
        <div class="sidebar-card">
            <h3><i class="bi bi-lightbulb-fill me-2"></i>Mẹo Nấu Ăn</h3>
            <div class="tips-item">
                <p><strong>💡 Tip 1:</strong> Ướp thịt với chút muối và tiêu ít nhất 30 phút trước khi nấu.</p>
            </div>
            <div class="tips-item">
                <p><strong>💡 Tip 2:</strong> Thêm một chút đường vào món mặn sẽ giúp cân bằng vị.</p>
            </div>
            <div class="tips-item">
                <p><strong>💡 Tip 3:</strong> Rau củ luộc với nước sôi giúp giữ màu xanh tươi.</p>
            </div>
        </div>
    </aside>
</div>

<script>
    (function loadJs() {
        if (typeof $ === 'undefined') {
            setTimeout(loadJs, 50);
            return;
        }
        const files = [
            '/js/recipe/recipe-list.js',
            '/js/index.js'
        ];
        files.forEach(src => {
            const script = document.createElement('script');
            script.src = src;
            document.body.appendChild(script);
        });
    })();
</script>
