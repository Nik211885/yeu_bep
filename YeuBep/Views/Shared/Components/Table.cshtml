@using YeuBep.Attributes.Table
@using YeuBep.Extensions
@using YeuBep.Helpers
@model YeuBep.ViewModels.PaginationViewModel<object>
<link rel="stylesheet" href="~/css/components/table.css" />
@{
    List<ButtonConfig> buttonConfigs = ViewBag.ButtonConfig;
    var items = Model.Items?.ToList() ?? new List<object>();
    
    // Helper function to get flattened properties
    List<(System.Reflection.PropertyInfo Property, string DisplayName, string PropertyPath)> GetFlattenedProperties(Type? type, string prefix = "")
    {
        var result = new List<(System.Reflection.PropertyInfo, string, string)>();
        var properties = type.GetProperties().Where(p => p.CanRead).ToList();
        
        foreach (var prop in properties)
        {
            if (prop.IsIgnoreColumn()) continue;
            
            var propPath = string.IsNullOrEmpty(prefix) ? prop.Name : $"{prefix}.{prop.Name}";
            var displayName = prop.GetNameColumn();
            
            // Check if property is a complex type (nested object)
            if (prop.PropertyType.IsClass && 
                prop.PropertyType != typeof(string) && 
                prop.PropertyType is { IsArray: false, IsGenericType: false })
            {
                // Recursively flatten nested properties
                var nestedProps = GetFlattenedProperties(prop.PropertyType, propPath);
                result.AddRange(nestedProps);
            }
            else if (prop.Name.ToUpper() != "ID")
            {
                result.Add((prop, displayName, propPath)!);
            }
        }
        
        return result;
    }
    
    // Helper function to get nested property value
    object? GetNestedValue(object? obj, string propertyPath)
    {
        if (obj == null) return null;
        
        var parts = propertyPath.Split('.');
        object? currentValue = obj;
        
        foreach (var part in parts)
        {
            if (currentValue == null) return null;
            
            var propInfo = currentValue.GetType().GetProperty(part);
            if (propInfo == null) return null;
            
            currentValue = propInfo.GetValue(currentValue);
        }

        if (currentValue is string stringValue)
        {
            return StringHelper.Split20Word(stringValue);
        }
        if (currentValue is DateTime dt)
        {
            return DateTimeHelper.ConvertDateTimeFormat(dt);
        }

        if (currentValue is DateTimeOffset dateTimeOffset)
        {
            return DateTimeHelper.ConvertDateTimeZoneFormat(dateTimeOffset);
        }

        if (currentValue is Enum enumValue)
        {
            return enumValue.GetLabelName();
        }
        return currentValue;
    }
    
    var flattenedProperties = items.FirstOrDefault() != null 
        ? GetFlattenedProperties(items.FirstOrDefault()?.GetType()) 
        : new List<(System.Reflection.PropertyInfo, string, string)>();
}
<div class="container">
    <div class="action-bar">
        <div>
            <button class="advanced-filter-toggle" id="advancedFilterToggle">Tìm kiếm nâng cao</button>
        </div>
        <div>
            <!-- Thêm -->
            @foreach (var buttonConfig in buttonConfigs)
            {
                var url = Url.Action(buttonConfig.Action, buttonConfig.Controller);
                switch (buttonConfig.Type)
                {
                    case ButtonTableType.Add:
                        <button data-url="@url"  class="btn btn-success" id="btnAdd" title="Thêm">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2Z"/>
                            </svg>
                        </button>
                        break;
                    case ButtonTableType.Edit:
                        <button data-url="@url" class="btn btn-warning text-white" id="btnEdit" disabled title="Sửa">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/>
                            </svg>
                        </button>
                        break;
                    case ButtonTableType.Delete:
                        <button data-url="@url" class="btn btn-danger" id="btnDelete" disabled title="Xóa">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5h9.916Zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47ZM8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5Z"/>
                            </svg>
                        </button>
                        break;
                    case ButtonTableType.Detail:
                        <button data-url="@url" class="btn btn-info text-white" id="btnView" disabled title="Xem">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                                <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                            </svg>
                        </button>
                        break;
                    case ButtonTableType.Approve:
                        <button data-url="@url" class="btn btn-success" id="btnApprove" disabled title="Duyệt">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                            </svg>
                        </button>
                        break;
                    case ButtonTableType.UnApprove:
                        <button data-url="@url" class="btn btn-danger" id="btnReject" disabled title="Từ chối">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
                            </svg>
                        </button>
                        break;
                    case ButtonTableType.Lock:
                        <button data-url="@url" class="btn btn-secondary" id="btnLock" disabled title="Khóa">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                            </svg>
                        </button>
                        break;
                    case ButtonTableType.Unlock:
                        <button data-url="@url" class="btn btn-warning text-white" id="btnUnlock" disabled title="Mở khóa">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M11 1a2 2 0 0 0-2 2v4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h5V3a3 3 0 0 1 6 0v4a.5.5 0 0 1-1 0V3a2 2 0 0 0-2-2z"/>
                            </svg>
                        </button>
                        break;
                }
            }
            <button class="btn btn-info text-white" id="btnRefresh" title="Làm mới">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                </svg>
            </button>
        </div>
    </div>

    <div class="advanced-filter-panel" id="advancedFilterPanel">
        <div id="advancedFilters"></div>
        <button class="add-filter-btn" id="addFilterBtn">+ Tìm kiếm</button>
    </div>
    <table id="dataTable">
        <thead>
        <tr>
            <th class="checkbox-cell">
                <input type="checkbox" id="selectAll">
            </th>
            @foreach (var (_, displayName, propertyPath) in flattenedProperties)
            {
                <th class="sortable" data-column="@displayName" data-path="@propertyPath">
                    @displayName <span class="sort-icon">↕</span>
                    <input type="text" class="filter-input" placeholder="" data-filter="@displayName" data-path="@propertyPath">
                </th>
            }
        </tr>
        </thead>
        <tbody id="tableBody">
        @if (Model.Items == null || Model.Items?.Count() == 0)
        {
            <tr>
                <td colspan="@(flattenedProperties.Count + 1)" class="no-results">Không có dữ liệu</td>
            </tr>
        }
        else
        {
            @foreach (var item in Model.Items!)
            {
                <tr>
                    <td class="checkbox-cell">
                        <input placeholder="" type="checkbox" class="row-checkbox check-item">
                    </td>
                    @foreach (var (_, _, propertyPath) in flattenedProperties)
                    {
                        var data = GetNestedValue(item, propertyPath);
                        if (data is ValueTuple<LabelLevel, string> tuple)
                        {
                            var (level, label) = tuple;
                            var colorLabel = level switch
                            {
                                LabelLevel.Danger  => "bg-danger",
                                LabelLevel.Primary => "bg-primary",
                                LabelLevel.Warning => "bg-warning",
                                _ => throw new ArgumentOutOfRangeException(nameof(level), level, null)
                            };
                            <td>
                                <span class="bg-primary p-2 rounded-pill text-white fw-bold @colorLabel">@label</span>
                            </td>
                        }
                        else
                        {
                            <td>@data</td>
                        }
                    }
                </tr>
            }
        }
        </tbody>
    </table>
    <div class="pagination">
        <div class="pagination-controls">
            <label>Dữ liệu trên bảng:</label>
            <select class="rows-per-page" id="rowsPerPage">
                <option value="10" selected>10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
        @await Component.InvokeAsync("PaginationComponent", Model.PaginationView)
    </div>
</div>
<script>
    (function loadTableJs() {
        if (typeof $ === 'undefined') {
            setTimeout(loadTableJs, 50);
            return;
        }
        const script = document.createElement('script');
        script.src = '/js/Components/table.js';
        document.body.appendChild(script);
    })();
</script>